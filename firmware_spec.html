<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2. Firmware Specification &#8212; 7819 DMS 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Interface Control Document" href="interface_control_doc.html" />
    <link rel="prev" title="1. Functional Specification" href="functional_spec.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="firmware-specification">
<span id="firmware-spec"></span><h1>2. Firmware Specification<a class="headerlink" href="#firmware-specification" title="Permalink to this headline">¶</a></h1>
<div class="section" id="copyright">
<h2>2.1. Copyright<a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h2>
<p>Copyright Creare LLC 2016.  This software specification is proprietary and should be considered confidential.  Reproduction or distribution prohibited without written permission from Creare.</p>
</div>
<div class="section" id="revision-log">
<span id="firmware-spec-revision-log"></span><h2>2.2. Revision Log<a class="headerlink" href="#revision-log" title="Permalink to this headline">¶</a></h2>
<table border="1" class="colwidths-given docutils" id="id1">
<caption><span class="caption-number">Table 2.1 </span><span class="caption-text">Revision Log</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Author</th>
<th class="head">Changes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>3/3/2017</td>
<td>MCR</td>
<td>Added <a class="reference internal" href="#laser-power"><span class="std std-ref">Laser Power</span></a> section. Keep laser on all the time except during <code class="docutils literal"><span class="pre">get_dark_level()</span></code>. Added trigger_delay to <a class="reference internal" href="#static-parameters"><span class="std std-ref">Static Parameters</span></a>. Added trigger_delay to <strong>Record Signals</strong> in <code class="docutils literal"><span class="pre">monitor_dispense()</span></code>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="introduction">
<h2>2.3. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The following sections describe the functionality that is required on the DMS controller. I have written this as a series of funtions for clarity (in my mind). The actual firmware and commands may be structured however you like, as long as it can do these things.</p>
</div>
<div class="section" id="identification">
<span id="id2"></span><h2>2.4. Identification<a class="headerlink" href="#identification" title="Permalink to this headline">¶</a></h2>
<p>The DMS should be able to return a unique identifier that distinguishes it among all others.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">idstr</span> <span class="pre">=</span> <span class="pre">id()</span></code></dt>
<dd>Return unique identifier string.</dd>
</dl>
</div>
<div class="section" id="laser-power">
<span id="id3"></span><h2>2.5. Laser Power<a class="headerlink" href="#laser-power" title="Permalink to this headline">¶</a></h2>
<p>The laser should be powered on whenever the DMS is powered, except during <code class="docutils literal"><span class="pre">get_dark_level()</span></code> (<a class="reference internal" href="#calibration"><span class="std std-ref">Calibration</span></a>). This is because diffraction patterns in the laser sheet shift during laser warmup for at least 10s of seconds, leading to unstable readings. We want to keep the laser at steady thermal equilibrium.</p>
</div>
<div class="section" id="alignment">
<span id="id4"></span><h2>2.6. Alignment<a class="headerlink" href="#alignment" title="Permalink to this headline">¶</a></h2>
<p>The DMS should stream the sensor data to the host at a minimum of 5 Hz until a command is received to stop this mode.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">align(resolution)</span></code></dt>
<dd>Stream the sensor image down-sampled to <code class="docutils literal"><span class="pre">resolution</span></code> pixels at 8-bit. The range of <code class="docutils literal"><span class="pre">resolution</span></code> is [3, 384], and the streamed image is a vector of <code class="docutils literal"><span class="pre">resolution</span></code> 8-bit integer values.</dd>
<dt><code class="docutils literal"><span class="pre">stop_align()</span></code></dt>
<dd>Stop streaming data.</dd>
</dl>
</div>
<div class="section" id="recording-raw-data">
<span id="id5"></span><h2>2.7. Recording Raw Data<a class="headerlink" href="#recording-raw-data" title="Permalink to this headline">¶</a></h2>
<p>The most basic function of the DMS will be to stream a segment of 1-D video data when it receives a command. It should also stream the value of the two trigger inputs at the time of each video data frame.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">stream_data(duration)</span></code></dt>
<dd>Stream raw video data and two trigger input values to host computer at <code class="docutils literal"><span class="pre">frame_rate</span></code> for <code class="docutils literal"><span class="pre">duration</span></code> ms.</dd>
</dl>
</div>
<div class="section" id="global-parameters">
<span id="id6"></span><h2>2.8. Global Parameters<a class="headerlink" href="#global-parameters" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#configuration-parameters"><span class="std std-ref">Configuration Parameters</span></a> should be set by the host application. These parameters define the dispense cycle and fault detection mode, and must be set before fault detection can occur. Once set, they remain constant until explicitly reset.</p>
<table border="1" class="colwidths-given docutils" id="configuration-parameters">
<caption><span class="caption-number">Table 2.2 </span><span class="caption-text">Configuration Parameters</span><a class="headerlink" href="#configuration-parameters" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">stream_diameter</span></code></td>
<td>The nominal diameter of the dispense stream in mils (.001 &#8221;). Range: [1, 50]. Typical values: 7 (1 uL cassette) and 14 (5 and 10 uL cassettes).</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">n_dispenses</span></code></td>
<td>The number of wells dispensed by a given channel on each microplate. Range: [1, 192]. Typical values are 12, 48, and 192.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">dispense_time</span></code></td>
<td>The duration that the pump runs while dispensing a single well, in ms. Range: [1, 8000].</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">dispense_period</span></code></td>
<td>The time interval at which wells are dispensed in ms. This value must be greater than <code class="docutils literal"><span class="pre">dispense_time</span></code>. Range: [1, 8150].</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">n_ref_history</span></code></td>
<td>The number of previous plates to include in the calculation of reference features for <a class="reference internal" href="#id11">Fault Detection</a>. Default is 10.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ref_mode</span></code></td>
<td>Can be <code class="docutils literal"><span class="pre">'user'</span></code> or <code class="docutils literal"><span class="pre">'history'</span></code>, and determines whether wells are compared to a user specified reference dispense or to a median of the recent plate dispenses for <a class="reference internal" href="#id11">Fault Detection</a>. Default is <code class="docutils literal"><span class="pre">'history'</span></code>.</td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="#static-parameters"><span class="std std-ref">Static Parameters</span></a> are expected to be constant and should be invisible to the end user.</p>
<table border="1" class="colwidths-given docutils" id="static-parameters">
<caption><span class="caption-number">Table 2.3 </span><span class="caption-text">Static Parameters</span><a class="headerlink" href="#static-parameters" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="13%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">frame_rate</span></code></td>
<td>1000</td>
<td>Sensor frame rate (Hz)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">pixel_pitch</span></code></td>
<td>15.75</td>
<td>Sensor pixel pitch (400 / 25.4, pixels per mm)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">n_pixels</span></code></td>
<td>384</td>
<td>Number of active pixels on sensor. (pixels)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cal_pin_diameter</span></code></td>
<td>0.80</td>
<td>Calibration fixture pin diameter (mm)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">n_cal_frames</span></code></td>
<td>100</td>
<td>Number of frames to integrate when collecting background and calibration images. Integer.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">filter_pix</span></code></td>
<td>7</td>
<td>Number of pixels for smoothing filter window. Odd integer. (pixels)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">cal_min_peak</span></code></td>
<td>0.1</td>
<td>Minimum height of calibration peaks. (unitless)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">min_stream_amp</span></code></td>
<td>0.1</td>
<td>Smallest amplitude to consider stream present. (mm)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">max_stream_width</span></code></td>
<td>1</td>
<td>Max stream width considered to be real. (mm)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">rel_min_illum</span></code></td>
<td>0.25</td>
<td>The minimum fraction (of median) considered illuminated in a background image.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">abs_min_illum</span></code></td>
<td>128</td>
<td>Absolute minimum acceptable background illumination.  A 12-bit integer. (counts)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">illum_dev_warn</span></code></td>
<td>0.5</td>
<td>The maximum relative deviation in background illumination that will not result in a warning.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">max_dark_level</span></code></td>
<td>256</td>
<td>The maximum dark level that won’t throw an error. (counts)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">trigger_delay</span></code></td>
<td>14</td>
<td>Delay before acting on a received trigger. (ms)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="calibration">
<span id="id7"></span><h2>2.9. Calibration<a class="headerlink" href="#calibration" title="Permalink to this headline">¶</a></h2>
<p>Before monitoring dispenses, the DMS must collect or compute the <a class="reference internal" href="#calibration-parameters">Calibration Parameters</a>. These should be stored in non-volatile memory and remain constant until calibration is run again.</p>
<table border="1" class="colwidths-given docutils" id="calibration-parameters">
<caption><span class="caption-number">Table 2.4 </span><span class="caption-text">Calibration Parameters</span><a class="headerlink" href="#calibration-parameters" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">dark_level</span></code></td>
<td>A single 12-bit integer representing the mean sensor signal in the absence of light.  Defaults to 0.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cal_background</span></code></td>
<td>A vector of 384 integers (12-bit) representing the nominal illumination in the absence of streams or any other obstruction, at the time of system calibration.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">cal_image</span></code></td>
<td>A vector of 384 values (12-bit integer mapped to [-1,1]) representing the image with the calibration fixture in place.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cal_pix_range</span></code></td>
<td>A pair of integers representing the range of pixels (first, last) that are illuminated by the laser.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">cal_bin_edges</span></code></td>
<td>A vector of 9 integers (units: pixels) that partition the 384 pixel sensor into 8 bins centered on the 8 dispense streams. The 8 bins are contiguous, but do not necessarily span the entire sensor.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cal_center</span></code></td>
<td>A vector of 8 values that define the nominal center points of the 8 channels using the calibration fixture. Units: pixels. Minimum precision: 0.01 pixels.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">cal_sigma</span></code></td>
<td>A vector of 8 values that define the nominal width of the 8 channel shadows using the calibration fixture. Units: pixels. Minimum precision: 0.01 pixels. Maximum value: 48.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cal_amp_scale</span></code></td>
<td>A vector of 8 values that define the shadow <em>amplitude scale</em> for each channel (mm/pixel). Minimum precision 0.001. Typical value: 0.25.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">cal_lateral_scale</span></code></td>
<td>A vector of 8 values that define the shadow <em>lateral scale</em> for each channel (mm/pixel). These scale factors are applied to lateral stream displacements, and account for the physical pixel pitch as well as the varying optical magnification across the sensor.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cal_sigma_scale</span></code></td>
<td>A vector of 8 values that define the shadow <em>sigma scale</em> for each channel (mm/pixel). These scale factors relate the shadow width to stream diameter, and account for the physical pixel pitch as well as the varying optical magnification across the sensor.</td>
</tr>
</tbody>
</table>
<p>The first step for initial sensor calibration is to determine the dark level, the voltage the sensor outputs in the absence of light.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">get_dark_level()</span></code></dt>
<dd>This should be done with the sensor covered. Turn the laser off. Collect <code class="docutils literal"><span class="pre">n_cal_frames</span></code> successive 12-bit images from the sensor at <code class="docutils literal"><span class="pre">frame_rate</span></code>, take the mean in the time dimension, then the median in the spatial dimension.  If this value is greater than <code class="docutils literal"><span class="pre">max_dark_level</span></code>, throw an error <code class="docutils literal"><span class="pre">'Sensor</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">dark.’</span></code>. Otherwise, assign to the <code class="docutils literal"><span class="pre">dark_level</span></code> parameter as an integer. Turn the laser back on.</dd>
</dl>
<p>The next step in calibration (and the first step in any subsequent data collection routine) is to collect a fresh background image. This should be done with the sensor illuminated by the laser, with no obstructions. This data is used to account for variations in laser power, dirty optical windows, etc.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">set_background()</span></code></dt>
<dd><ol class="first last arabic simple">
<li>Collect <code class="docutils literal"><span class="pre">n_cal_frames</span></code> successive raw 12-bit images from the sensor at <code class="docutils literal"><span class="pre">frame_rate</span></code>, take the mean in the time dimension, subtract <code class="docutils literal"><span class="pre">dark_level</span></code> (saturate at 0), and assign this 384 pixel vector to <code class="docutils literal"><span class="pre">candidate_bg</span></code>.</li>
<li>If the median value of <code class="docutils literal"><span class="pre">candidate_bg</span></code> is less than <code class="docutils literal"><span class="pre">abs_min_illum</span></code>, throw an warning <code class="docutils literal"><span class="pre">‘Insufficient</span> <span class="pre">background</span> <span class="pre">illumination.’</span></code> and exit the function. Otherwise, assign <code class="docutils literal"><span class="pre">candidate_bg</span></code> to <code class="docutils literal"><span class="pre">cal_background</span></code>.</li>
<li>Find the median value in <code class="docutils literal"><span class="pre">cal_background</span></code> and multiply this by <code class="docutils literal"><span class="pre">rel_min_illum</span></code>.  Find the first and last of the 384 pixels that are illuminated at greater than this value. Assign these two indices to <code class="docutils literal"><span class="pre">cal_pix_range</span></code>.</li>
</ol>
</dd>
</dl>
<p>After this initial background has been collected, all subsequent data collection uses the following transform to correct each image for the known background:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">image</span> <span class="pre">=</span> <span class="pre">collect_image(background)</span></code></dt>
<dd>Collect one 384 pixel frame from the sensor, subtract <code class="docutils literal"><span class="pre">dark_level</span></code> with saturation at 0, and call the result <code class="docutils literal"><span class="pre">data</span></code>. Then, <code class="docutils literal"><span class="pre">image</span> <span class="pre">=</span> <span class="pre">1</span> <span class="pre">–</span> <span class="pre">(data</span> <span class="pre">./</span> <span class="pre">background)</span></code>. Set all <code class="docutils literal"><span class="pre">image</span></code> pixels outside of <code class="docutils literal"><span class="pre">cal_pix_range</span></code> to zero.  The result is a 384 pixel vector with values that, under normal circumstances, lie in the range of [ 0.05, 1.0]. However, an invalid background collection can make it take on negative values, and we want to make sure not to mask this problem by saturation. I think it would suit our purposes to make <code class="docutils literal"><span class="pre">image</span></code> a 12-bit value mapped to [-1, 1].</dd>
</dl>
<p>The next step is to perform the actual calibration. This is done with the calibration fixture in place. It has metal pins of known diameter in the nominal stream locations.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">calibrate()</span></code></dt>
<dd><ol class="first last arabic">
<li><p class="first">Collect <code class="docutils literal"><span class="pre">n_cal_frames</span></code> successive images from the sensor at <code class="docutils literal"><span class="pre">frame_rate</span></code> (using the <code class="docutils literal"><span class="pre">collect_image(cal_background)</span></code> transform), take the mean in the time dimension, and assign the result to <code class="docutils literal"><span class="pre">cal_image</span></code>.</p>
</li>
<li><p class="first">Lowpass filter <code class="docutils literal"><span class="pre">cal_image</span></code> with a <code class="docutils literal"><span class="pre">filter_pix</span></code> wide, square, centered moving average (zero padded). Be sure there is no filter delay. For example:</p>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="n">filtered_image</span> <span class="p">=</span> <span class="n">conv</span><span class="p">(</span> <span class="n">cal_image</span><span class="p">,</span> <span class="c">...</span>
        <span class="nb">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">filter_pix</span><span class="p">)</span><span class="o">/</span><span class="n">filter_pix</span><span class="p">,</span> <span class="s">&#39;same&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>In <code class="docutils literal"><span class="pre">filtered_image</span></code>, find all peaks with minimum height of <code class="docutils literal"><span class="pre">min_cal_peak</span></code> and minimum inter-peak spacing of <code class="docutils literal"><span class="pre">filter_pix</span></code>. There should be exactly 8 peaks found. If not, throw warning <code class="docutils literal"><span class="pre">‘8</span> <span class="pre">peaks</span> <span class="pre">not</span> <span class="pre">found</span> <span class="pre">in</span> <span class="pre">calibration</span> <span class="pre">image.’</span></code> and exit the function.</p>
</li>
<li><p class="first">Define <code class="docutils literal"><span class="pre">cal_bin_edges</span></code> to form 8 contiguous bins with edges centered between the peaks found above. The first and last edge are defined by requiring that the first and last peaks are centered in their bins. If these outer edges fall outside of <code class="docutils literal"><span class="pre">cal_pix_range</span></code>, throw warning <code class="docutils literal"><span class="pre">‘Calibration</span> <span class="pre">not</span> <span class="pre">centered</span> <span class="pre">on</span> <span class="pre">sensor.’</span></code> and exit the function.</p>
</li>
<li><p class="first">Within each of the 8 bins of the unfiltered <code class="docutils literal"><span class="pre">cal_image</span></code>, calculate the following quantities (Matlab syntax here and throughout the document):</p>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span> <span class="c">% step through bins/streams</span>

        <span class="n">pix</span> <span class="p">=</span> <span class="n">bin_edges</span><span class="p">(</span><span class="nb">i</span><span class="p">):</span><span class="n">bin_edges</span><span class="p">(</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Y2</span> <span class="p">=</span> <span class="n">cal_image</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span> <span class="o">.*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cal_image</span><span class="p">(</span><span class="n">pix</span><span class="p">))</span>
        <span class="n">sY2</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">Y2</span><span class="p">)</span>

        <span class="n">cal_center</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span> <span class="n">Y2</span> <span class="o">.*</span> <span class="n">pix</span> <span class="p">)</span> <span class="o">./</span> <span class="n">sY2</span>

        <span class="n">d2</span> <span class="p">=</span> <span class="p">(</span> <span class="n">pix</span> <span class="o">-</span> <span class="n">cal</span><span class="p">.</span><span class="n">center</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">)</span><span class="o">.^</span><span class="mi">2</span>

        <span class="n">cal_sigma</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="n">sum</span><span class="p">(</span> <span class="n">Y2</span> <span class="o">.*</span> <span class="n">d2</span> <span class="p">)</span> <span class="o">./</span> <span class="n">sY2</span> <span class="p">)</span>
        <span class="n">cal_rss</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="n">sY2</span> <span class="p">)</span>
        <span class="n">cal_amp_scale</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">cal_pin_diameter</span> <span class="o">/</span> <span class="n">cal_rss</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>
        <span class="n">cal_sigma_scale</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">cal_pin_diameter</span> <span class="o">/</span> <span class="n">cal_sigma</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">sigmaMag</span> <span class="p">=</span> <span class="n">cal_sigma</span> <span class="o">./</span> <span class="n">cal_sigma</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">magnification</span> <span class="p">=</span> <span class="n">polyval</span><span class="p">(</span> <span class="n">polyfit</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="n">sigmaMag</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<span class="n">cal_lateral_scale</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">./</span> <span class="p">(</span><span class="n">magnification</span> <span class="o">*</span> <span class="n">pixel_pitch</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="extracting-signals">
<span id="id8"></span><h2>2.10. Extracting Signals<a class="headerlink" href="#extracting-signals" title="Permalink to this headline">¶</a></h2>
<p>The raw 1D video data collected during a dispense must be reduced to three time-domain <a class="reference internal" href="#signals"><span class="std std-ref">Signals</span></a> for each of the 8 dispenser channels. Each is an 8 x <code class="docutils literal"><span class="pre">n_frames</span></code> array with one value corresponding to each video frame for each of the 8 channels. When monitoring a dispense, only these three signals need to be stored for fault detection analysis. If these signals can be computed in real time, the raw video data need not be stored.</p>
<table border="1" class="colwidths-given docutils" id="signals">
<caption><span class="caption-number">Table 2.5 </span><span class="caption-text">Signals</span><a class="headerlink" href="#signals" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Signal</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">signal_amp</span></code></td>
<td>The root-sum-squated (rss) value of the unitless signal amplitude within each channel bin. Each channel is calibrated by multiplication with the appropriate entry in <code class="docutils literal"><span class="pre">cal_amp_scale</span></code>, and final units are mm. Maximum expected value is 3 mm. Minimum precision is 0.001 mm.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">signal_disp</span></code></td>
<td>The lateral displacement of each stream from its <em>nominal</em> position. Each channel is calibrated by multiplication with the appropriate entry in <code class="docutils literal"><span class="pre">cal_lateral_scale</span></code>, and final units are mm. Maximum expected value is 1.5 mm. Minimum precision is 0.001 mm.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">signal_width</span></code></td>
<td>The width of the stream for each channel. This is signal_sigmal calibrated by multiplication with the appropriate entry in <code class="docutils literal"><span class="pre">cal_sigma_scale</span></code>, and final units are mm. Maximum expected value is 3 mm. Minimum precision is 0.001 mm.</td>
</tr>
</tbody>
</table>
<p>While recording data during a dispense, the three signals are calculated as follows:</p>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">n_frames</span> <span class="c">% step through time</span>
        <span class="n">image</span> <span class="p">=</span> <span class="n">collect_image</span><span class="p">(</span><span class="n">tmp_background</span><span class="p">)</span> <span class="c">% transform raw sensor frame</span>

        <span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span> <span class="c">% step through bins/streams</span>

                <span class="n">pix</span> <span class="p">=</span> <span class="n">bin_edges</span><span class="p">(</span><span class="nb">i</span><span class="p">):</span><span class="n">bin_edges</span><span class="p">(</span><span class="nb">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">y2</span> <span class="p">=</span> <span class="n">image</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span> <span class="o">.*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">image</span><span class="p">(</span><span class="n">pix</span><span class="p">))</span>
                <span class="n">sy2</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>

                <span class="n">ssq</span> <span class="p">=</span> <span class="nb">sign</span><span class="p">(</span><span class="n">sy2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sy2</span><span class="p">))</span>
                <span class="n">signal_amp</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span>  <span class="n">ssq</span> <span class="o">*</span> <span class="n">cal_amp_scale</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">signal_amp</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_stream_amp</span>
                        <span class="n">center</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="nb">nan</span>
                        <span class="n">signal_sigma</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="nb">nan</span>

                <span class="k">else</span>
                        <span class="n">center</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span> <span class="n">y2</span> <span class="o">.*</span> <span class="n">pix</span> <span class="p">)</span> <span class="o">./</span> <span class="n">sy2</span>
                        <span class="n">d2</span> <span class="p">=</span> <span class="p">(</span> <span class="n">pix</span> – <span class="n">center</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span><span class="o">.^</span><span class="mi">2</span>

                        <span class="n">sigma</span> <span class="p">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="n">sum</span><span class="p">(</span> <span class="n">y2</span><span class="o">.*</span><span class="n">d2</span><span class="p">)</span> <span class="o">./</span> <span class="n">sy2</span> <span class="p">)</span>
                        <span class="n">signal_width</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">cal_sigma_scale</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">signal_sigma</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_stream_sigma</span>
                                <span class="n">center</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="nb">nan</span>
                                <span class="n">signal_sigma</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="nb">nan</span>
                        <span class="k">end</span>
                <span class="k">end</span>
        <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>After recording an entire dispense we must decide the nominal positions of the streams so we can calculate their absolute lateral offset from nominal.  We assume that the tips are spaced the same as the calibration cassette, but possibly offset.</p>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="n">mean_center</span> <span class="p">=</span> <span class="n">nanmean</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c">% 8 bins/streams</span>
<span class="n">offset</span> <span class="p">=</span> <span class="n">median</span><span class="p">(</span> <span class="n">mean_center</span> – <span class="n">cal_center</span> <span class="p">)</span>
<span class="n">disp_pix</span> <span class="p">=</span> <span class="nb">bsxfun</span><span class="p">(@</span><span class="n">minus</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">cal_center</span><span class="p">)</span> – <span class="n">offset</span>
<span class="n">signal_disp</span> <span class="p">=</span> <span class="nb">bsxfun</span><span class="p">(@</span><span class="n">times</span><span class="p">,</span> <span class="n">disp_pix</span><span class="p">,</span> <span class="n">cal_lateral_scale</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="monitor-dispense">
<span id="id9"></span><h2>2.11. Monitor Dispense<a class="headerlink" href="#monitor-dispense" title="Permalink to this headline">¶</a></h2>
<p>When the DMS receives a <code class="docutils literal"><span class="pre">monitor_dispense()</span></code> command, it should go through a series of automated steps to wait for the dispense and then collect <a class="reference internal" href="#dispense-data"><span class="std std-numref">Table 2.6</span></a> <a class="reference internal" href="#dispense-data">Dispense Data</a>, which should be stored for possible download to the host if requested.  This data may be discarded when a new <code class="docutils literal"><span class="pre">monitor_dispense()</span></code> command is received.</p>
<table border="1" class="colwidths-given docutils" id="dispense-data">
<caption><span class="caption-number">Table 2.6 </span><span class="caption-text">Dispense Data</span><a class="headerlink" href="#dispense-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Data</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">signals</span></code></td>
<td>A data structure that includes all the <cite>Signals</cite> computed over the duration of the dispense.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">triggers</span></code></td>
<td>An array of timestamps of the alternating falling and rising edges of the pump trigger over the duration of the dispense (i.e. during the interval that the plate trigger is active). The number of falling and rising edges expected is <code class="docutils literal"><span class="pre">n_dispenses</span></code> each.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">info</span></code></td>
<td>A data structure that stores all warnings or informational messages thrown during the dispense.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">features</span></code></td>
<td>A data structure that stores all the features computed from signals during the dispense as listed in <a class="reference internal" href="#feature-specifications"><span class="std std-numref">Table 2.8</span></a> <a class="reference internal" href="#feature-specifications"><span class="std std-ref">Feature specifications</span></a>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">faults</span></code></td>
<td>A data structure that stores all the fault information computed for the dispense as listed in <a class="reference internal" href="#fault-detection-data"><span class="std std-numref">Table 2.11</span></a> <a class="reference internal" href="#fault-detection-data"><span class="std std-ref">Fault Detection Data</span></a>.</td>
</tr>
</tbody>
</table>
<p>The procedure is defined as follows:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">monitor_dispense()</span></code></dt>
<dd><ol class="first last arabic">
<li><p class="first"><strong>Prepare for Background</strong>  Immediately upon receiving the command, the DMS should begin recording raw 12-bit images (<em>without</em> the <code class="docutils literal"><span class="pre">collect_image</span></code> transform) into a rolling buffer that is <code class="docutils literal"><span class="pre">n_cal_frames</span></code> long.</p>
</li>
<li><p class="first"><strong>Wait for Trigger</strong>  The DMS has two trigger inputs illustrated in <a class="reference internal" href="#biotek-triggers"><span class="std std-numref">Fig. 2.1</span></a>. The pump trigger is active whenever the dispense pump is running (i.e. fluid is flowing). The plate trigger is active whenever a plate is being dispensed.  This allows us to distinguish when the pump is running for reasons other than dispensing a plate, such as a purge or pre-dispense. Both triggers are normally high, active low.  The DMS should wait until it receives a plate trigger, then proceed immediately to the next step.</p>
<div class="figure align-center" id="biotek-triggers">
<a class="reference internal image-reference" href="_images/BioTek_Triggers.png"><img alt="BioTek Trigger Diagram" src="_images/BioTek_Triggers.png" style="width: 591.6px; height: 202.79999999999998px;" /></a>
<p class="caption"><span class="caption-number">Fig. 2.1 </span><span class="caption-text">BioTek Trigger Diagram.</span></p>
</div>
</li>
<li><p class="first"><strong>Collect Background</strong>  After receiving the plate trigger, take the mean of the rolling buffer along the time dimension, subtract <code class="docutils literal"><span class="pre">dark_level</span></code>, and store this array in both <code class="docutils literal"><span class="pre">tmp_background</span></code> and info.background.</p>
</li>
<li><p class="first"><strong>Validate Background</strong>  Compare <code class="docutils literal"><span class="pre">tmp_background</span></code> to <code class="docutils literal"><span class="pre">cal_background</span></code> to be sure that it is acceptable.  This task is low priority and can happen after the dispense is complete.  For each of the two background images, compute the mean value within each of the 8 bins defined by <code class="docutils literal"><span class="pre">cal_bin_edges</span></code>. If these values differ by more than <code class="docutils literal"><span class="pre">illum_dev_warn</span></code> (relative) for any bin, throw a warning stating the bin number.  If any of the 8 values for <code class="docutils literal"><span class="pre">tmp_background</span></code> are less than <code class="docutils literal"><span class="pre">abs_min_illum</span></code>, throw a warning stating the bin number.  These warnings should be stored in <code class="docutils literal"><span class="pre">info</span></code>.</p>
</li>
<li><p class="first"><strong>Record Signals</strong> When the first pump trigger is received (with the plate trigger already active) begin recording signals as described in <a class="reference internal" href="#extracting-signals"><span class="std std-ref">Extracting Signals</span></a>, normalizing with <code class="docutils literal"><span class="pre">tmp_background</span></code>.  Continue until the plate trigger becomes inactive.  Also record timestamps for the rising and falling edges of the pump trigger, delayed by <code class="docutils literal"><span class="pre">trigger_delay</span></code>. (This delay accounts for the lag between the electrical trigger signals and the physical fluid stream.)  These triggers will be used to determine the <code class="docutils literal"><span class="pre">during_dispense</span></code> (pump trigger low) and <code class="docutils literal"><span class="pre">between_dispense</span></code> (pump trigger high) signal segments used in <a class="reference internal" href="#computing-features"><span class="std std-ref">Computing Features</span></a>.</p>
</li>
<li><p class="first"><strong>Compute Features</strong>  Compute features as described in <a class="reference internal" href="#computing-features"><span class="std std-ref">Computing Features</span></a>.</p>
</li>
<li><p class="first"><strong>Detect Faults</strong>  Compute and store faults as described in <a class="reference internal" href="#fault-detection"><span class="std std-ref">Fault Detection</span></a>.</p>
</li>
<li><p class="first"><strong>Store History</strong>  Store the <code class="docutils literal"><span class="pre">plate_features</span></code> (see <a class="reference internal" href="#computing-features"><span class="std std-ref">Computing Features</span></a>) from the current dispense in <code class="docutils literal"><span class="pre">history</span></code> (see <a class="reference internal" href="#fault-detection"><span class="std std-ref">Fault Detection</span></a>).</p>
</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="computing-features">
<span id="id10"></span><h2>2.12. Computing Features<a class="headerlink" href="#computing-features" title="Permalink to this headline">¶</a></h2>
<p>Each well on a microplate is characterized by nine features that are used to determine if the well dispense was faulty. Each feature is a single number and is calculated using one of the three time signals (<code class="docutils literal"><span class="pre">signal_amp</span></code>, <code class="docutils literal"><span class="pre">signal_disp</span></code>, <code class="docutils literal"><span class="pre">signal_width</span></code>). With the exception of the <code class="docutils literal"><span class="pre">amp_corr</span></code> feature (see <a class="reference internal" href="#comp-amp-corr"><span class="std std-ref">Computing amp_corr feature</span></a>), only the row of the time signal corresponding to the channel that the well is in is used when calculating the feature. Additionally, only certain frames of the time signal are used. In some cases, the frames or time interval used is during the time period that the well is being dispensed (<code class="docutils literal"><span class="pre">during_dispense</span></code>), in other cases it is the time after the dispense of the well, but before the next well dispense (<code class="docutils literal"><span class="pre">between_dispense</span></code>). Finally, it could also be the combination of <code class="docutils literal"><span class="pre">during_dispense</span></code> and <code class="docutils literal"><span class="pre">between_dispense</span></code>.</p>
<div class="section" id="determining-during-dispense-and-between-dispense-time-intervals">
<h3>2.12.1. Determining <code class="docutils literal"><span class="pre">during_dispense</span></code> and <code class="docutils literal"><span class="pre">between_dispense</span></code> time intervals<a class="headerlink" href="#determining-during-dispense-and-between-dispense-time-intervals" title="Permalink to this headline">¶</a></h3>
<p>The time intervals, <code class="docutils literal"><span class="pre">during_dispense</span></code> and <code class="docutils literal"><span class="pre">between_dispense</span></code>, can be determined using the plate trigger and the pump trigger. All intervals are while the plate trigger is low. Changes in the value of the pump trigger mark the boundries between the <code class="docutils literal"><span class="pre">during_dispense</span></code> and <code class="docutils literal"><span class="pre">between_dispense</span></code> time intervals. As such these intervals are strictly not overlapping. The pump trigger is high for the <code class="docutils literal"><span class="pre">during_dispense</span></code> time interval and low for <code class="docutils literal"><span class="pre">between_dispense</span></code>. For a given well dispense, the  <code class="docutils literal"><span class="pre">during_dispense</span></code> interval precedes the <code class="docutils literal"><span class="pre">between_dispense</span></code> interval corresponding to the same well dispense.</p>
<p>The end of the <code class="docutils literal"><span class="pre">between_dispense</span></code> interval of the last well dispense is the only point in time that can not be determined by a change in the pump trigger. This is because the pump trigger does not transition back to low to mark this end point. It stays high up through the end of the plate dispense when the value of the plate trigger becomes high again. Because it is desirable to have all <code class="docutils literal"><span class="pre">between_dispense</span></code> time intervals be roughly the same duration, it is necessary to determine this end point by averaging the duration of all previous <code class="docutils literal"><span class="pre">between_dispense</span></code> intervals from the same plate dispense. <a class="reference internal" href="#dispense-timeline"><span class="std std-numref">Table 2.7</span></a> depicts the pump trigger timeline and indicates where the various intervals fall for each of the <code class="docutils literal"><span class="pre">n_dispenses</span></code> well dispenses of a single plate.</p>
<table border="1" class="colwidths-given docutils" id="dispense-timeline">
<caption><span class="caption-number">Table 2.7 </span><span class="caption-text">Dispense Timeline. Increasing time from top to bottom.</span><a class="headerlink" href="#dispense-timeline" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="31%" />
<col width="23%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Time</th>
<th class="head">Interval</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">t_start</span></code></td>
<td>&nbsp;</td>
<td>Plate trigger goes LOW</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">t_low(1</span></code>)</td>
<td>&nbsp;</td>
<td>Pump tigger goes LOW</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td><code class="docutils literal"><span class="pre">during_dispense</span></code></td>
<td>well dispense #1</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">t_high(1)</span></code></td>
<td>&nbsp;</td>
<td>Pump trigger goes HIGH</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td><code class="docutils literal"><span class="pre">between_dispense</span></code></td>
<td>well dispense #1</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">t_low(2)</span></code></td>
<td>&nbsp;</td>
<td>Pump tigger goes LOW</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td><code class="docutils literal"><span class="pre">during_dispense</span></code></td>
<td>well dispense #2</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">t_high(2)</span></code></td>
<td>&nbsp;</td>
<td>Pump trigger goes HIGH</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td><code class="docutils literal"><span class="pre">between_dispense</span></code></td>
<td>well dispense #2</td>
</tr>
<tr class="row-odd"><td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">t_low(n_dispenses)</span></code></td>
<td>&nbsp;</td>
<td>Pump tigger goes LOW</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td><code class="docutils literal"><span class="pre">during_dispense</span></code></td>
<td>last well dispense of plate (# n_dispenses)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">t_high(n_dispenses)</span></code></td>
<td>&nbsp;</td>
<td>Pump trigger goes HIGH</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td><code class="docutils literal"><span class="pre">between_dispense</span></code></td>
<td>last well dispense of plate (# n_dispenses)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">t_high(n_dispenses)</span> <span class="pre">+</span> <span class="pre">avg(t_low(i+1)</span>&#160; <span class="pre">–</span> <span class="pre">t_high(i))</span></code></td>
<td>&nbsp;</td>
<td>END of last <code class="docutils literal"><span class="pre">between_dispense</span></code> No event. Must be computed using average of the previous <code class="docutils literal"><span class="pre">between_dispense</span></code> durations.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">t_end</span></code></td>
<td>&nbsp;</td>
<td>Plate trigger goes HIGH</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="computing-standard-features">
<h3>2.12.2. Computing standard features<a class="headerlink" href="#computing-standard-features" title="Permalink to this headline">¶</a></h3>
<p>In general, computing the value of a feature for a well involves the following steps:</p>
<ol class="arabic simple">
<li>Select the signal corresponding to the feature (<code class="docutils literal"><span class="pre">signal_amp</span></code>, <code class="docutils literal"><span class="pre">signal_disp</span></code>, <code class="docutils literal"><span class="pre">signal_width</span></code>).</li>
<li>Select the row of the time signal corresponding to the well’s channel.</li>
<li>Select the frames (columns) of the time signal corresponding to the appropriate time interval (<code class="docutils literal"><span class="pre">during_dispense</span></code>, <code class="docutils literal"><span class="pre">between_dispense</span></code>).</li>
<li>Compute the mean or standard deviation of the selected portion of the time signal.</li>
<li>Optionally, normalize and then take the base 10 logarithm. Whether or not to do this step is indicated in the <a class="reference internal" href="#feature-specifications">Feature Specifications</a> table (under the column &#8220;Normalized&#8221;).<ol class="arabic">
<li>Normalization: divide by the median (across all <code class="docutils literal"><span class="pre">8</span> <span class="pre">x</span> <span class="pre">n_dispenses</span></code> wells on the entire plate) of the result from the previous step.</li>
<li>Then, compute the base 10 logarithm of the result from normalization.</li>
</ol>
</li>
</ol>
<p>The details of this process for each of the nine features can be found in <a class="reference internal" href="#feature-specifications">Feature Specifications</a>. The time signal and the time interval for the amp_corr feature are listed in <a class="reference internal" href="#feature-specifications">Feature Specifications</a>. However, after step 3, the amp_corr computation is different from the other features and is specified in <a class="reference internal" href="#comp-amp-corr"><span class="std std-ref">Computing amp_corr feature</span></a>.</p>
<table border="1" class="colwidths-given docutils" id="feature-specifications">
<caption><span class="caption-number">Table 2.8 </span><span class="caption-text">Feature specifications</span><a class="headerlink" href="#feature-specifications" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="18%" />
<col width="18%" />
<col width="18%" />
<col width="9%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Feature</th>
<th class="head">Signal</th>
<th class="head">Time Interval</th>
<th class="head">Normalized</th>
<th class="head">Operations</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">disp_mean</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_disp</span></code></td>
<td>both</td>
<td>No</td>
<td>mean</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">disp_sdev</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_disp</span></code></td>
<td>both</td>
<td>No</td>
<td>standard deviation</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">width_mean</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_width</span></code></td>
<td>both</td>
<td>No</td>
<td>mean</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">width_sdev</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_width</span></code></td>
<td>both</td>
<td>No</td>
<td>standard deviation</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">width_mean_n</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_width</span></code></td>
<td>both</td>
<td>Yes</td>
<td>mean, normalize, log</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">amp_mean_btw_n</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_amp</span></code></td>
<td><code class="docutils literal"><span class="pre">between_dispense</span></code></td>
<td>Yes</td>
<td>mean, normalize, log</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">amp_mean_dur_n</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_amp</span></code></td>
<td><code class="docutils literal"><span class="pre">during_dispense</span></code></td>
<td>Yes</td>
<td>mean, normalize, log</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">amp_mean_dur</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_amp</span></code></td>
<td><code class="docutils literal"><span class="pre">during_dispense</span></code></td>
<td>No</td>
<td>mean</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">amp_corr</span></code></td>
<td><code class="docutils literal"><span class="pre">signal_amp</span></code></td>
<td><code class="docutils literal"><span class="pre">during_dispense</span></code></td>
<td>No</td>
<td>See <a class="reference internal" href="#comp-amp-corr"><span class="std std-ref">below</span></a>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="computing-amp-corr-feature">
<span id="comp-amp-corr"></span><h3>2.12.3. Computing <code class="docutils literal"><span class="pre">amp_corr</span></code> feature<a class="headerlink" href="#computing-amp-corr-feature" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">amp_corr</span></code> feature is calculated from the <code class="docutils literal"><span class="pre">signal_amp</span></code> signal. It is a measure of the similarity between the signal in one channel to the median signal (<code class="docutils literal"><span class="pre">amp_med</span></code>) across all of the channels. It can range from <code class="docutils literal"><span class="pre">0.0</span></code> to <code class="docutils literal"><span class="pre">+2.0</span></code>. As with the other features, there is a single <code class="docutils literal"><span class="pre">amp_corr</span></code> value for each well on a plate. What follows is a description of the calculation of a single <code class="docutils literal"><span class="pre">amp_corr</span></code> value for a well in channel <code class="docutils literal"><span class="pre">ch</span></code>. The frames corresponding to the <code class="docutils literal"><span class="pre">during_dispense</span></code> time interval of the dispense event of this well will collectively be referred to as <code class="docutils literal"><span class="pre">during_dispense_frames</span></code>. Therefore, <code class="docutils literal"><span class="pre">signal_amp(ch,</span> <span class="pre">during_dispense_frames)</span></code> would be a 1-dimensional time signal whose length is the number of frames in the particular <code class="docutils literal"><span class="pre">during_dispense</span></code> interval.</p>
<p>Calculation of <code class="docutils literal"><span class="pre">amp_med</span></code> which is a 1-dimensional signal with the same length as <code class="docutils literal"><span class="pre">signal_amp(ch,</span> <span class="pre">during_dispense_frames)</span></code>:</p>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="p">=</span> <span class="n">during_dispense_frames</span> <span class="c">% step through frames that are part of this well dispense event&#39;s during_dispense interval</span>
    <span class="n">amp_med</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="n">median</span><span class="p">(</span><span class="n">signal_amp</span><span class="p">(:,</span><span class="n">t</span><span class="p">))</span> <span class="c">% for frame t compute median value of signal_amp across all channels</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Note, <code class="docutils literal"><span class="pre">amp_med</span></code> need only be computed once for every well dispense event. It can be resued for calculation of each of the channel&#8217;s particular <code class="docutils literal"><span class="pre">amp_corr</span></code> feature.</p>
<p>Calculation of <code class="docutils literal"><span class="pre">amp_corr</span></code> for channel <code class="docutils literal"><span class="pre">ch</span></code>:</p>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="n">S</span> <span class="p">=</span> <span class="n">signal_amp</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">during_dispense_frames</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">signal_amp</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">during_dispense_frames</span><span class="p">))</span>
<span class="n">M</span> <span class="p">=</span> <span class="n">amp_med</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">amp_med</span><span class="p">)</span>
<span class="n">amp_corr</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span> <span class="p">(</span> <span class="n">S</span><span class="o">*</span><span class="n">M</span><span class="o">&#39;</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">S</span><span class="o">&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">M</span><span class="o">&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="c">% S and M are assumed to be row vectors so S * M&#39; is the dot product</span>
</pre></div>
</div>
</div>
<div class="section" id="computing-plate-features">
<h3>2.12.4. Computing <code class="docutils literal"><span class="pre">plate_features</span></code><a class="headerlink" href="#computing-plate-features" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">plate_features</span></code> is a data structure that contains 8 values for each feature, defined as the median value for that feature within each channel. Compute this each time a plate is processed. It can be overwritten for each new plate.</p>
</div>
</div>
<div class="section" id="fault-detection">
<span id="id11"></span><h2>2.13. Fault Detection<a class="headerlink" href="#fault-detection" title="Permalink to this headline">¶</a></h2>
<p>Dispense faults are detected at the well level by comparing its feature values to one of the following:</p>
<ol class="arabic">
<li><p class="first"><strong>A pre-defined absolute value.</strong>
This allows us to catch things that are completely out-of-bounds. However, we need to know what the feature value <em>should</em> be. Depending on the feature, this might be a function of the <a class="reference internal" href="#configuration-parameters"><span class="std std-ref">Configuration Parameters</span></a>, the cassette in use, the fluid properties, etc. So these absolute metrics are difficult to determine and not very effective.</p>
</li>
<li><p class="first"><strong>A reference value based on either:</strong></p>
<ul class="simple">
<li>a validated reference dispense designated by the user or</li>
<li>the median value from a few of the preceeding plate dispenses.</li>
</ul>
<p>This allows us to catch changes that occur over time without needing to know anything about the dispense configuration.</p>
</li>
<li><p class="first"><strong>The median value among wells on the current plate.</strong>
This allows us to catch individual well dispenses or channels that look different from others on the plate without needing to know anyting about the dispense configuration. The <em>normalized</em> features do this implicitly.</p>
</li>
</ol>
<p>The parameters required for fault detection are defined in <a class="reference internal" href="#fault-detection-parameters"><span class="std std-numref">Table 2.9</span></a>.</p>
<table border="1" class="colwidths-given docutils" id="fault-detection-parameters">
<caption><span class="caption-number">Table 2.9 </span><span class="caption-text">Fault Detection Parameters</span><a class="headerlink" href="#fault-detection-parameters" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">history</span></code></td>
<td>A FIFO stack of <code class="docutils literal"><span class="pre">plate_features</span></code> data structures from as many as <code class="docutils literal"><span class="pre">n_ref_history</span></code> previous plate dispenses.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ref_features</span></code></td>
<td>A data structure which contains either the <code class="docutils literal"><span class="pre">plate_features</span></code> from the reference dispense or the median of the well values in each channel of <code class="docutils literal"><span class="pre">history</span></code>, i.e. 8 channel values for each feature.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">fault_categories</span></code></td>
<td>A data structure which contains the <a class="reference internal" href="#fault-categories"><span class="std std-ref">Fault Categories</span></a> table.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">fault_descriptions</span></code></td>
<td>A data structure which contains the <a class="reference internal" href="#fault-descriptions"><span class="std std-ref">Fault Descriptions</span></a> table.</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal"><span class="pre">history</span></code> must be automatically cleared whenever any of the <a class="reference internal" href="#configuration-parameters"><span class="std std-numref">Table 2.2</span></a> <a class="reference internal" href="#configuration-parameters"><span class="std std-ref">Configuration Parameters</span></a> or <a class="reference internal" href="#calibration-parameters"><span class="std std-numref">Table 2.4</span></a> <a class="reference internal" href="#calibration-parameters"><span class="std std-ref">Calibration Parameters</span></a> change. The user or host system is responsible for explicitly clearing the history when there is a change in the dispense cartridge, fluid, etc.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">clear_history()</span></code></dt>
<dd>Empty the <code class="docutils literal"><span class="pre">history</span></code> stack.</dd>
</dl>
<p>There are a few discrete categories of faults that indicate the severity of the event and the level of response required. These are givin in <a class="reference internal" href="#fault-categories"><span class="std std-numref">Table 2.10</span></a>.</p>
<table border="1" class="colwidths-given docutils" id="fault-categories">
<caption><span class="caption-number">Table 2.10 </span><span class="caption-text">Fault Categories</span><a class="headerlink" href="#fault-categories" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Code</th>
<th class="head">Category string</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">0</span></code></td>
<td><code class="docutils literal"><span class="pre">'--'</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">1</span></code></td>
<td><code class="docutils literal"><span class="pre">'notice'</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">2</span></code></td>
<td><code class="docutils literal"><span class="pre">'warning'</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">3</span></code></td>
<td><code class="docutils literal"><span class="pre">'error'</span></code></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The data that results from fault detection on a single plate is defined in <a class="reference internal" href="#fault-detection-data"><span class="std std-numref">Table 2.11</span></a>.</p>
<table border="1" class="colwidths-given docutils" id="fault-detection-data">
<caption><span class="caption-number">Table 2.11 </span><span class="caption-text">Fault Detection Data</span><a class="headerlink" href="#fault-detection-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">well_faults</span></code></td>
<td>An <code class="docutils literal"><span class="pre">8</span> <span class="pre">x</span> <span class="pre">n_dispenses</span></code> array of 32-bit packets. Each pair of 2 bits code for the <a class="reference internal" href="#fault-categories"><span class="std std-ref">Fault Category</span></a> corresponding to each of the individual <a class="reference internal" href="#well-fault-tests"><span class="std std-ref">Well Fault Tests</span></a> defined below in sequential order, beginning with the least significant bits. Initialize to all zeros.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ch_faults</span></code></td>
<td>An abbreviated fault output. A single 16-bit packet, 2 bits per channel, coding for the maximum <a class="reference internal" href="#fault-categories"><span class="std std-ref">Fault Category</span></a> recorded on each of the 8 channels.</td>
</tr>
</tbody>
</table>
<p>The thresholds used for fault detection are given in <a class="reference internal" href="#fault-detection-thresholds"><span class="std std-numref">Table 2.12</span></a>. We anticipate that these will ultimately remain constant, and so should be hardcoded.  However, they may change during testing and development, and new parameters or stream diameters may be added in the future.</p>
<table border="1" class="colwidths-given docutils" id="fault-detection-thresholds">
<caption><span class="caption-number">Table 2.12 </span><span class="caption-text">Fault Detection Thresholds</span><a class="headerlink" href="#fault-detection-thresholds" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="14%" />
<col width="43%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head"><code class="docutils literal"><span class="pre">stream_diameter</span> <span class="pre">=</span> <span class="pre">7</span></code></th>
<th class="head"><code class="docutils literal"><span class="pre">stream_diameter</span> <span class="pre">=</span> <span class="pre">14</span></code></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">amp_corr_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.1,</span> <span class="pre">0.4,</span> <span class="pre">0.8]</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.1,</span> <span class="pre">0.1,</span> <span class="pre">0.1]</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">amp_mean_dur_n_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.1,</span> <span class="pre">0.3,</span> <span class="pre">0.5]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">amp_mean_dur_n_l</span></code></td>
<td><code class="docutils literal"><span class="pre">[-0.2,</span> <span class="pre">-0.3,</span> <span class="pre">-0.5]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">amp_mean_dur_min</span></code></td>
<td><code class="docutils literal"><span class="pre">?</span></code></td>
<td><code class="docutils literal"><span class="pre">?</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">amp_mean_btw_n_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.75,</span> <span class="pre">2.0]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">disp_mean_lu</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code></td>
<td><code class="docutils literal"><span class="pre">?</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">disp_sdev_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.6,</span> <span class="pre">0.4,</span> <span class="pre">0.25]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">width_mean_n_lu</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.4,</span> <span class="pre">0.6]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">width_mean_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.5,</span> <span class="pre">0.6]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">width_mean_l</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.14,</span> <span class="pre">0.1]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?]</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">width_sdev_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[0.12,</span> <span class="pre">0.16]</span></code></td>
<td><code class="docutils literal"><span class="pre">[?,</span> <span class="pre">?]</span></code></td>
</tr>
</tbody>
</table>
<p>The tests to be applied to each well are defined in <a class="reference internal" href="#well-fault-tests"><span class="std std-numref">Table 2.13</span></a> below. In each definition:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">feature_name</span></code> refers to that value for a given well from the current dispense.</li>
<li><code class="docutils literal"><span class="pre">rf.feature_name.med</span></code> refers to the median of the 8 values stored for that feature in <code class="docutils literal"><span class="pre">ref_features</span></code>.</li>
<li><code class="docutils literal"><span class="pre">rf.feature_name(i)</span></code> refers to the value stored for that feature in <code class="docutils literal"><span class="pre">ref_features</span></code> in the channel corresponding to the channel of the current well.</li>
<li>For thresholds with multiple values, these correspond to the multiple category codes.</li>
</ul>
<table border="1" class="colwidths-given docutils" id="well-fault-tests">
<caption><span class="caption-number">Table 2.13 </span><span class="caption-text">Well Fault Tests</span><a class="headerlink" href="#well-fault-tests" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="3%" />
<col width="77%" />
<col width="21%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">id</th>
<th class="head">Condition</th>
<th class="head">Fault Category</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td><code class="docutils literal"><span class="pre">amp_mean_dur</span> <span class="pre">&lt;</span> <span class="pre">amp_mean_dur_min</span></code></td>
<td><code class="docutils literal"><span class="pre">3</span></code></td>
</tr>
<tr class="row-odd"><td>2</td>
<td><code class="docutils literal"><span class="pre">amp_corr</span> <span class="pre">&gt;</span> <span class="pre">amp_cor_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-even"><td>3</td>
<td><code class="docutils literal"><span class="pre">amp_mean_dur_n</span> <span class="pre">&gt;</span> <span class="pre">amp_mean_dur_n_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-odd"><td>4</td>
<td><code class="docutils literal"><span class="pre">amp_mean_dur_n</span> <span class="pre">&lt;</span> <span class="pre">amp_mean_dur_n_l</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-even"><td>5</td>
<td><code class="docutils literal"><span class="pre">log10(amp_mean_dur</span> <span class="pre">/</span> <span class="pre">rf.amp_mean_dur.med)</span> <span class="pre">&gt;</span> <span class="pre">amp_mean_dur_n_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-odd"><td>6</td>
<td><code class="docutils literal"><span class="pre">log10(amp_mean_dur</span> <span class="pre">/</span> <span class="pre">rf.amp_mean_dur.med)</span> <span class="pre">&lt;</span> <span class="pre">amp_mean_dur_n_l</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-even"><td>7</td>
<td><code class="docutils literal"><span class="pre">amp_corr</span> <span class="pre">&gt;</span> <span class="pre">amp_cor_u(2)</span> <span class="pre">&amp;</span> <span class="pre">amp_mean_dur_n</span> <span class="pre">&lt;</span> <span class="pre">amp_mean_dur_n_l(1)</span></code></td>
<td><code class="docutils literal"><span class="pre">3</span></code></td>
</tr>
<tr class="row-odd"><td>8</td>
<td><code class="docutils literal"><span class="pre">amp_mean_btw_n</span> <span class="pre">&gt;</span> <span class="pre">amp_mean_btw_n_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-even"><td>9</td>
<td><code class="docutils literal"><span class="pre">abs(disp_mean)</span> <span class="pre">&gt;</span> <span class="pre">disp_mean_lu</span></code></td>
<td><code class="docutils literal"><span class="pre">[3]</span></code></td>
</tr>
<tr class="row-odd"><td>10</td>
<td><code class="docutils literal"><span class="pre">abs(disp_mean-rf.disp_mean(i))</span> <span class="pre">&gt;</span> <span class="pre">disp_mean_lu</span></code></td>
<td><code class="docutils literal"><span class="pre">[2]</span></code></td>
</tr>
<tr class="row-even"><td>11</td>
<td><code class="docutils literal"><span class="pre">disp_sdev</span> <span class="pre">&gt;</span> <span class="pre">disp_sdev_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
<tr class="row-odd"><td>12</td>
<td><code class="docutils literal"><span class="pre">abs(width_mean_n)</span> <span class="pre">&gt;</span> <span class="pre">width_mean_n_lu</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2]</span></code></td>
</tr>
<tr class="row-even"><td>13</td>
<td><code class="docutils literal"><span class="pre">width_mean</span> <span class="pre">&gt;</span> <span class="pre">width_mean_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2]</span></code></td>
</tr>
<tr class="row-odd"><td>14</td>
<td><code class="docutils literal"><span class="pre">width_mean</span> <span class="pre">&lt;</span> <span class="pre">width_mean_l</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2]</span></code></td>
</tr>
<tr class="row-even"><td>15</td>
<td><code class="docutils literal"><span class="pre">width_sdev</span> <span class="pre">&gt;</span> <span class="pre">width_sdev_u</span></code></td>
<td><code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2]</span></code></td>
</tr>
</tbody>
</table>
<p>Description strings for each of these fault tests are given in <a class="reference internal" href="#fault-descriptions"><span class="std std-numref">Table 2.14</span></a> below. Both the <code class="docutils literal"><span class="pre">fault_categories</span></code> and <code class="docutils literal"><span class="pre">fault_descriptions</span></code> data structures should be made available for query by the host so that it can update its display functions when firmware changes.</p>
<table border="1" class="colwidths-given docutils" id="fault-descriptions">
<caption><span class="caption-number">Table 2.14 </span><span class="caption-text">Fault Descriptions</span><a class="headerlink" href="#fault-descriptions" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">id</th>
<th class="head">Description string</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td><code class="docutils literal"><span class="pre">'Lower</span> <span class="pre">signal</span> <span class="pre">than</span> <span class="pre">expected</span> <span class="pre">for</span> <span class="pre">reported</span> <span class="pre">cassette.'</span></code></td>
</tr>
<tr class="row-odd"><td>2</td>
<td><code class="docutils literal"><span class="pre">'Stream</span> <span class="pre">dynamics</span> <span class="pre">poorly</span> <span class="pre">correlated</span> <span class="pre">to</span> <span class="pre">other</span> <span class="pre">channels.'</span></code></td>
</tr>
<tr class="row-even"><td>3</td>
<td><code class="docutils literal"><span class="pre">'High</span> <span class="pre">signal</span> <span class="pre">compared</span> <span class="pre">to</span> <span class="pre">other</span> <span class="pre">channels.'</span></code></td>
</tr>
<tr class="row-odd"><td>4</td>
<td><code class="docutils literal"><span class="pre">'Low</span> <span class="pre">signal</span> <span class="pre">compared</span> <span class="pre">to</span> <span class="pre">other</span> <span class="pre">channels.'</span></code></td>
</tr>
<tr class="row-even"><td>5</td>
<td><code class="docutils literal"><span class="pre">'High</span> <span class="pre">signal</span> <span class="pre">compared</span> <span class="pre">to</span> <span class="pre">reference.'</span></code></td>
</tr>
<tr class="row-odd"><td>6</td>
<td><code class="docutils literal"><span class="pre">'Low</span> <span class="pre">signal</span> <span class="pre">compared</span> <span class="pre">to</span> <span class="pre">reference.'</span></code></td>
</tr>
<tr class="row-even"><td>7</td>
<td><code class="docutils literal"><span class="pre">'Poor</span> <span class="pre">correlation,</span> <span class="pre">low</span> <span class="pre">signal.'</span></code></td>
</tr>
<tr class="row-odd"><td>8</td>
<td><code class="docutils literal"><span class="pre">'Signal</span> <span class="pre">between</span> <span class="pre">dispenses.</span> <span class="pre">Likely</span> <span class="pre">clog</span> <span class="pre">or</span> <span class="pre">attached</span> <span class="pre">droplet.'</span></code></td>
</tr>
<tr class="row-even"><td>9</td>
<td><code class="docutils literal"><span class="pre">'Unexpected</span> <span class="pre">stream</span> <span class="pre">location.'</span></code></td>
</tr>
<tr class="row-odd"><td>10</td>
<td><code class="docutils literal"><span class="pre">'Stream</span> <span class="pre">displaced</span> <span class="pre">relative</span> <span class="pre">to</span> <span class="pre">reference.'</span></code></td>
</tr>
<tr class="row-even"><td>11</td>
<td><code class="docutils literal"><span class="pre">'Laterally</span> <span class="pre">unstable</span> <span class="pre">stream.'</span></code></td>
</tr>
<tr class="row-odd"><td>12</td>
<td><code class="docutils literal"><span class="pre">'Stream</span> <span class="pre">diameter</span> <span class="pre">differs</span> <span class="pre">from</span> <span class="pre">other</span> <span class="pre">channels.'</span></code></td>
</tr>
<tr class="row-even"><td>13</td>
<td><code class="docutils literal"><span class="pre">'Oversized</span> <span class="pre">stream</span> <span class="pre">for</span> <span class="pre">reported</span> <span class="pre">cassette.'</span></code></td>
</tr>
<tr class="row-odd"><td>14</td>
<td><code class="docutils literal"><span class="pre">'Undersized</span> <span class="pre">stream</span> <span class="pre">for</span> <span class="pre">reported</span> <span class="pre">cassette.'</span></code></td>
</tr>
<tr class="row-even"><td>15</td>
<td><code class="docutils literal"><span class="pre">'Unstable</span> <span class="pre">stream</span> <span class="pre">diameter.'</span></code></td>
</tr>
</tbody>
</table>
<p>Now it&#8217;s time to actually detect the faults.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">detect_faults()</span></code></dt>
<dd><p class="first">If <code class="docutils literal"><span class="pre">ref_mode</span></code> is <code class="docutils literal"><span class="pre">'history'</span></code>, then for each feature, take the median of all wells of all plates in each channel of <code class="docutils literal"><span class="pre">history</span></code> and assign this value to the corresponding entry of <code class="docutils literal"><span class="pre">ref_features</span></code>.</p>
<p>If <code class="docutils literal"><span class="pre">ref_mode</span></code> is <code class="docutils literal"><span class="pre">'history'</span></code> and <code class="docutils literal"><span class="pre">history</span></code> is empty, or if <code class="docutils literal"><span class="pre">ref_mode</span></code> is <code class="docutils literal"><span class="pre">'user'</span></code> and <code class="docutils literal"><span class="pre">ref_features</span></code> has not been assigned, generate message <code class="docutils literal"><span class="pre">'No</span> <span class="pre">valid</span> <span class="pre">reference</span> <span class="pre">for</span> <span class="pre">fault</span> <span class="pre">detection.'</span></code> (to be stored in <code class="docutils literal"><span class="pre">info</span></code>) and exit fault detection.</p>
<p>Execute the <a class="reference internal" href="#well-fault-tests"><span class="std std-ref">Well Fault Tests</span></a> listed in <a class="reference internal" href="#well-fault-tests"><span class="std std-numref">Table 2.13</span></a> for each well of the current plate, using the <a class="reference internal" href="#fault-detection-thresholds"><span class="std std-ref">Fault Detection Thresholds</span></a> corresponding to the current value of <code class="docutils literal"><span class="pre">stream_diameter</span></code>. If a test evaluates as true, assign the appropriate <a class="reference internal" href="#fault-categories"><span class="std std-ref">Fault Category</span></a> to the appropriate entry in <code class="docutils literal"><span class="pre">well_faults</span></code>. If a well receives more than one <a class="reference internal" href="#fault-categories"><span class="std std-ref">Fault Category</span></a>, retain only the highest value.</p>
<p class="last">After all well tests are complete, assign the maximum fault category in each channel to the appropriate entry in <code class="docutils literal"><span class="pre">ch_faults</span></code>.</p>
</dd>
</dl>
</div>
<div class="section" id="set-reference-dispense">
<span id="id12"></span><h2>2.14. Set Reference Dispense<a class="headerlink" href="#set-reference-dispense" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">set_reference_dispense()</span></code></dt>
<dd>Assign the <code class="docutils literal"><span class="pre">plate_features</span></code> data structure from the most recent dispense in <code class="docutils literal"><span class="pre">history</span></code> to <code class="docutils literal"><span class="pre">ref_features</span></code>. (If <code class="docutils literal"><span class="pre">history</span></code> is empty, throw and appropriate error code and exit.)  If <code class="docutils literal"><span class="pre">ref_mode</span></code> is <code class="docutils literal"><span class="pre">'user'</span></code>, this will be used as the reference for subsequent <a class="reference internal" href="#id11">Fault Detection</a> as described above.</dd>
</dl>
</div>
<div class="section" id="return-fault-data">
<span id="id13"></span><h2>2.15. Return Fault Data<a class="headerlink" href="#return-fault-data" title="Permalink to this headline">¶</a></h2>
<p>The DMS needs a few functions for returning data to the host:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">return_well_faults()</span></code></dt>
<dd>Send the <code class="docutils literal"><span class="pre">well_faults</span></code> array from the most recent dispence to the host.</dd>
<dt><code class="docutils literal"><span class="pre">return_ch_faults()</span></code></dt>
<dd>Send the <code class="docutils literal"><span class="pre">ch_faults</span></code> array from the most recent dispence to the host.</dd>
<dt><code class="docutils literal"><span class="pre">return_dispense_data()</span></code></dt>
<dd>Send all <a class="reference internal" href="#dispense-data"><span class="std std-ref">Dispense Data</span></a> from the most recent dispense to the host.</dd>
</dl>
</div>
<div class="section" id="expose-parameters-to-host">
<h2>2.16. Expose Parameters to Host<a class="headerlink" href="#expose-parameters-to-host" title="Permalink to this headline">¶</a></h2>
<p>Many of the parameters defined in this spec need to be made available to the host for both read and write access as defined in the <a class="reference internal" href="interface_spec.html#interface-spec"><span class="std std-ref">Interface Specification</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/Creare_DMS.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2. Firmware Specification</a><ul>
<li><a class="reference internal" href="#copyright">2.1. Copyright</a></li>
<li><a class="reference internal" href="#revision-log">2.2. Revision Log</a></li>
<li><a class="reference internal" href="#introduction">2.3. Introduction</a></li>
<li><a class="reference internal" href="#identification">2.4. Identification</a></li>
<li><a class="reference internal" href="#laser-power">2.5. Laser Power</a></li>
<li><a class="reference internal" href="#alignment">2.6. Alignment</a></li>
<li><a class="reference internal" href="#recording-raw-data">2.7. Recording Raw Data</a></li>
<li><a class="reference internal" href="#global-parameters">2.8. Global Parameters</a></li>
<li><a class="reference internal" href="#calibration">2.9. Calibration</a></li>
<li><a class="reference internal" href="#extracting-signals">2.10. Extracting Signals</a></li>
<li><a class="reference internal" href="#monitor-dispense">2.11. Monitor Dispense</a></li>
<li><a class="reference internal" href="#computing-features">2.12. Computing Features</a><ul>
<li><a class="reference internal" href="#determining-during-dispense-and-between-dispense-time-intervals">2.12.1. Determining <code class="docutils literal"><span class="pre">during_dispense</span></code> and <code class="docutils literal"><span class="pre">between_dispense</span></code> time intervals</a></li>
<li><a class="reference internal" href="#computing-standard-features">2.12.2. Computing standard features</a></li>
<li><a class="reference internal" href="#computing-amp-corr-feature">2.12.3. Computing <code class="docutils literal"><span class="pre">amp_corr</span></code> feature</a></li>
<li><a class="reference internal" href="#computing-plate-features">2.12.4. Computing <code class="docutils literal"><span class="pre">plate_features</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#fault-detection">2.13. Fault Detection</a></li>
<li><a class="reference internal" href="#set-reference-dispense">2.14. Set Reference Dispense</a></li>
<li><a class="reference internal" href="#return-fault-data">2.15. Return Fault Data</a></li>
<li><a class="reference internal" href="#expose-parameters-to-host">2.16. Expose Parameters to Host</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="functional_spec.html" title="previous chapter">1. Functional Specification</a></li>
      <li>Next: <a href="interface_control_doc.html" title="next chapter">3. Interface Control Document</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/firmware_spec.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Creare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/firmware_spec.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
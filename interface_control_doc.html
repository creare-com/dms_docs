<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2. Interface Control Document &#8212; 7819 DMS 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Interface Specification" href="interface_spec.html" />
    <link rel="prev" title="1. Firmware Specification" href="firmware_spec.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="interface-control-document">
<span id="icd"></span><h1>2. Interface Control Document<a class="headerlink" href="#interface-control-document" title="Permalink to this headline">¶</a></h1>
<div class="section" id="copyright">
<h2>2.1. Copyright<a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h2>
<p>Copyright Creare LLC 2016.  This software specification is proprietary and should be considered confidential.  Reproduction or distribution prohibited without written permission from Creare.</p>
</div>
<div class="section" id="introduction">
<h2>2.2. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This document describes the communication protocols used between the DMS controller (hereafter simply referred to as the DMS),
and the host computer.  It partially replicates information found in the header file, dmsCodes.h, found in the ‘Shared’ area
of the source code tree.  Every effort has been made to make these two documents agree, but in the case of disagreement
dmsCodes.h, and thus the source code, prevail.</p>
</div>
<div class="section" id="usb-interface">
<h2>2.3. USB Interface<a class="headerlink" href="#usb-interface" title="Permalink to this headline">¶</a></h2>
<p>Communication between the DMS and the host PC occurs over a USB 2.0, Full speed (12 Mbps) connection.  Creare recommends,
and our example code utilizes, Microsoft’s WinUSB driver system, but the interface is generic USB and so any low level USB
access library, such as lib-usb, could be used.</p>
<p>The vendor ID is currently 0xABCD.  This is a bogus vendor ID, because at this time Creare is not registered with the USB
Implementers Forum.  However, it is adequate for non-public device deployment.  The product ID is 0x7819.</p>
<p>Two endpoints are defined.  Endpoint 0 is the standard control endpoint required for all USB devices.  The DMS makes use
of this endpoint to receive commands and return results.</p>
<p>Endpoint 1 is a standard bulk endpoint.  This endpoint is used to stream raw data samples from the DMS to the host,
for example in alignment mode.  The DMS has no support for bulk streaming to the device.</p>
<p>Note that in all cases, all data elements are transmitted and received in LSB (little endian) format.</p>
</div>
<div class="section" id="endpoint-0-commands">
<h2>2.4. Endpoint 0 Commands<a class="headerlink" href="#endpoint-0-commands" title="Permalink to this headline">¶</a></h2>
<p>The DMS supports the commands shown in Table 1.  Note that these are ‘Vendor’ Device Requests; refer to Chapter 9 of the
USB 2.0 specification.  A ‘Read’ is defined here as the DMS sending control data back to the host (Device-to-host);
a ‘Write’ is defined as the host sending additional data along with the command (Host-to-device).  If the length is
0 the direction is immaterial.</p>
<table border="1" class="colwidths-given docutils" id="supported-commands-summary">
<caption><span class="caption-number">Table 2.1 </span><span class="caption-text">Supported Commands Summary</span><a class="headerlink" href="#supported-commands-summary" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Description</th>
<th class="head">R/W</th>
<th class="head">bRequest</th>
<th class="head">wValue</th>
<th class="head">wIndex</th>
<th class="head">wLength</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>STATUS</td>
<td>Controller condition</td>
<td>R</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>12</td>
</tr>
<tr class="row-odd"><td>ID</td>
<td>Build date and unique ID</td>
<td>R</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>TODO</td>
</tr>
<tr class="row-even"><td>CONFIG_GET</td>
<td>Read configuration data</td>
<td>R</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>CONFIG_SET</td>
<td>Write configuration data</td>
<td>W</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>CALIBRATE</td>
<td>Run a calibration process</td>
<td>R</td>
<td>5</td>
<td>1, 2, or 3</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>GET_CALIBRATION</td>
<td>Get calibration results</td>
<td>R</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>1688</td>
</tr>
<tr class="row-even"><td>STORE_CALIBRATION</td>
<td>Write current calibration to non-volatile memory</td>
<td>R</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>MONITOR_DISPENSE</td>
<td>Begin monitoring</td>
<td>R</td>
<td>8</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="row-even"><td>GET_DISPENSE_DATA</td>
<td>Return results from monitoring</td>
<td>R</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>TBD</td>
</tr>
<tr class="row-odd"><td>STREAM</td>
<td>Start / stop streaming of raw data from sensor</td>
<td>R</td>
<td>10</td>
<td>0 or 1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>The commands are described in more detail below.</p>
</div>
<div class="section" id="status">
<h2>2.5. Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>In response to this command, the DMS returns its current state of operation.  This command should be used
to poll the DMS (~10 Hz) to determine the result of other commands.</p>
<table border="1" class="colwidths-given docutils" id="manual-control-data">
<caption><span class="caption-number">Table 2.2 </span><span class="caption-text">Manual Control Data</span><a class="headerlink" href="#manual-control-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Data Item</th>
<th class="head">Field Lengths (bytes)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>State (u32)</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>Flags (u32)</td>
<td>4</td>
</tr>
<tr class="row-even"><td>Last Reported Error (u32)</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>The following states are currently defined.</p>
<table border="1" class="colwidths-given docutils" id="controller-states">
<caption><span class="caption-number">Table 2.3 </span><span class="caption-text">Controller States</span><a class="headerlink" href="#controller-states" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Code</th>
<th class="head">State</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>OFF</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>INITIALIZATION</td>
</tr>
<tr class="row-even"><td>2</td>
<td>READY</td>
</tr>
<tr class="row-odd"><td>3-9</td>
<td>RESERVED</td>
</tr>
<tr class="row-even"><td>10</td>
<td>CALIBRATION</td>
</tr>
<tr class="row-odd"><td>11-2 <sup>32</sup></td>
<td>RESERVED</td>
</tr>
</tbody>
</table>
<p>The following flag bits are defined.</p>
<table border="1" class="colwidths-given docutils" id="controller-status-bit-field">
<caption><span class="caption-number">Table 2.4 </span><span class="caption-text">Controller Status Bit Field</span><a class="headerlink" href="#controller-status-bit-field" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Bits</th>
<th class="head">Status</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0-3</td>
<td>RESERVED</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Configuration Fail (Hardware Error)</td>
</tr>
<tr class="row-even"><td>5-19</td>
<td>RESERVED</td>
</tr>
<tr class="row-odd"><td>20</td>
<td>Configuration Using Defaults</td>
</tr>
<tr class="row-even"><td>21-31</td>
<td>RESERVED</td>
</tr>
</tbody>
</table>
<p>The following error codes are currently defined.</p>
<table border="1" class="colwidths-given docutils" id="error-codes">
<caption><span class="caption-number">Table 2.5 </span><span class="caption-text">Error Codes</span><a class="headerlink" href="#error-codes" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Code</th>
<th class="head">Mnemonic</th>
<th class="head">Suggested Display Setting</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>DMS_ERR_NONE</td>
<td>No error.</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>DMS_ERR_SENSOR_NOT_DARK</td>
<td>Sensor is not dark.</td>
</tr>
<tr class="row-even"><td>2</td>
<td>DMS_ERR_INSUFFICIENT_BG_ILLUM</td>
<td>Insufficient background illumination.</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>DMS_ERR_INSUFFICIENT_PEAKS</td>
<td>8 peaks not found in calibration image.</td>
</tr>
<tr class="row-even"><td>4</td>
<td>DMS_ERR_CAL_NOT_CENTERED</td>
<td>Calibration not centered on sensor.</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>DMS_ERR_ILLEGAL_STATE</td>
<td>The DMS cannot accept that command at this time.</td>
</tr>
<tr class="row-even"><td>6</td>
<td>DMS_ERR_UNSUPPORTED_OPERATION</td>
<td>The DMS does not support that operation.</td>
</tr>
<tr class="row-odd"><td>7-255</td>
<td>RESERVED</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id">
<h2>2.6. ID<a class="headerlink" href="#id" title="Permalink to this headline">¶</a></h2>
<p>This command causes the DMS to return the build date and time of its firmware, and the unique
ID associated with the processor.</p>
<table border="1" class="colwidths-given docutils" id="identification-data">
<caption><span class="caption-number">Table 2.6 </span><span class="caption-text">Identification Data</span><a class="headerlink" href="#identification-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Data Item</th>
<th class="head">Field Length (bytes)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Build Date / Time String(Mmm dd yyyy hh:mm:ss)</td>
<td>24</td>
</tr>
<tr class="row-odd"><td>Unique ID (u32 x 4)</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="config-get">
<h2>2.7. Config Get<a class="headerlink" href="#config-get" title="Permalink to this headline">¶</a></h2>
<p>In response to the CONFIG_GET command, the DMS will return the current value of all configuration parameters.  See Table 7.7.</p>
<table border="1" class="colwidths-given docutils" id="configuration-data">
<caption><span class="caption-number">Table 2.7 </span><span class="caption-text">Configuration Data</span><a class="headerlink" href="#configuration-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Data Item</th>
<th class="head">Field Length (bytes)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Stream Diameter mils, (u32)</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>Number of Dispenses (u32)</td>
<td>4</td>
</tr>
<tr class="row-even"><td>Dispense Time, msec (u32)</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>Dispense Period, msec (u32)</td>
<td>4</td>
</tr>
<tr class="row-even"><td>N Ref History (u32)</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>User / Ref Mode (u32)</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>Please refer to the firmware specification for the exact usage of these parameters.</p>
</div>
<div class="section" id="config-set">
<h2>2.8. Config Set<a class="headerlink" href="#config-set" title="Permalink to this headline">¶</a></h2>
<p>The host may overwrite the configuration parameters with this command.  The data provided
should exactly match Table 7.7.</p>
</div>
<div class="section" id="calibrate">
<h2>2.9. Calibrate<a class="headerlink" href="#calibrate" title="Permalink to this headline">¶</a></h2>
<p>This command requests the DMS to perform a calibration operation.  The DMS must be in the READY state.
There are currently three operations defined, which the host may select via the wValue control parameter; see Table 7.8.</p>
<table border="1" class="colwidths-given docutils" id="calibration-operations">
<caption><span class="caption-number">Table 2.8 </span><span class="caption-text">Calibration Operations</span><a class="headerlink" href="#calibration-operations" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">wValue</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>RESERVED</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>Get Dark Level</td>
<td>1</td>
</tr>
<tr class="row-even"><td>Set Background</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>Calibrate</td>
<td>3</td>
</tr>
<tr class="row-even"><td>RESERVED</td>
<td>4-65535</td>
</tr>
</tbody>
</table>
<p>See the firmware specification for the full details of these calibration operations.</p>
<p>After the operation is commanded, STATUS should be polled to observed the return of the DMS to the READY state.
If the error code is zero, then the calibration operation was successful; otherwise there was a problem that requires
operator attention.</p>
</div>
<div class="section" id="get-calibration">
<h2>2.10. Get Calibration<a class="headerlink" href="#get-calibration" title="Permalink to this headline">¶</a></h2>
<p>The DMS returns the current calibration in response to this command. This is primarily for debugging purposes.
The calibration has the format shown in Table 7.9.</p>
<table border="1" class="colwidths-given docutils" id="calibration-data">
<caption><span class="caption-number">Table 2.9 </span><span class="caption-text">Calibration Data</span><a class="headerlink" href="#calibration-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Data Item</th>
<th class="head">Field Length (bytes)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Dark Level (u16)</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>Background (384 * u16)</td>
<td>768</td>
</tr>
<tr class="row-even"><td>Pixel Range (2 * u16)</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>Bin Edges (2 * u16)</td>
<td>18</td>
</tr>
<tr class="row-even"><td>Cal Image (2 * u16)</td>
<td>768</td>
</tr>
<tr class="row-odd"><td>Cal Center (8 * f32)</td>
<td>32</td>
</tr>
<tr class="row-even"><td>Cal Sigma (8 * f32)</td>
<td>32</td>
</tr>
<tr class="row-odd"><td>Cal Amp Scale (8 * f32)</td>
<td>32</td>
</tr>
<tr class="row-even"><td>Cal Lateral Scale (8 * f32)</td>
<td>32</td>
</tr>
</tbody>
</table>
<p>Please refer to the firmware specification for the meaning of these calibration elements.</p>
</div>
<div class="section" id="store-calibration">
<h2>2.11. Store Calibration<a class="headerlink" href="#store-calibration" title="Permalink to this headline">¶</a></h2>
<p>After the calibration is computed, it is held in RAM only.  After this command is executed the
calibration is written to non-volatile memory.</p>
</div>
<div class="section" id="monitor-dispense">
<h2>2.12. Monitor Dispense<a class="headerlink" href="#monitor-dispense" title="Permalink to this headline">¶</a></h2>
<p>This command instructs the DMS to begin monitoring the sensor for a dispense operation.</p>
</div>
<div class="section" id="get-dispense-data">
<h2>2.13. Get Dispense Data<a class="headerlink" href="#get-dispense-data" title="Permalink to this headline">¶</a></h2>
<p>After monitoring is complete, this command causes the DMS to emit the last results of the operation.  TBD.</p>
</div>
<div class="section" id="stream">
<h2>2.14. Stream<a class="headerlink" href="#stream" title="Permalink to this headline">¶</a></h2>
<p>This command controls raw data streaming.  The wValue parameter controls the streaming: 0 halts streaming,
1 begins streaming, and all other values are reserved.  After receiving this command with a wValue of 1,
the DMS will begin streaming the raw data from the sensor to the host at the full, 1kHz rate, on Bulk Transfer
endpoint 1.  The DMS will stream packets of the form described in Table 10 until commanded to stop.  Note the
DMS must be in the READY state to use this command.</p>
<table border="1" class="colwidths-given docutils" id="stream-packet-format">
<caption><span class="caption-number">Table 2.10 </span><span class="caption-text">Stream Packet Format</span><a class="headerlink" href="#stream-packet-format" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Data Item</th>
<th class="head">Field Length (bytes)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Header (u32)</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>Packed Samples (u32)</td>
<td>150</td>
</tr>
</tbody>
</table>
<p>The header consists of two parts.  The upper 16 bits holds the value 0x7819, which may be used to scan for the start
of a packet if synchronization is lost.  The lower 16 bits contain trigger status.  Bit 0 is the pump trigger, while
bit 1 is the plate trigger.  Bits 2 through 15 are reserved.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/Creare_DMS.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2. Interface Control Document</a><ul>
<li><a class="reference internal" href="#copyright">2.1. Copyright</a></li>
<li><a class="reference internal" href="#introduction">2.2. Introduction</a></li>
<li><a class="reference internal" href="#usb-interface">2.3. USB Interface</a></li>
<li><a class="reference internal" href="#endpoint-0-commands">2.4. Endpoint 0 Commands</a></li>
<li><a class="reference internal" href="#status">2.5. Status</a></li>
<li><a class="reference internal" href="#id">2.6. ID</a></li>
<li><a class="reference internal" href="#config-get">2.7. Config Get</a></li>
<li><a class="reference internal" href="#config-set">2.8. Config Set</a></li>
<li><a class="reference internal" href="#calibrate">2.9. Calibrate</a></li>
<li><a class="reference internal" href="#get-calibration">2.10. Get Calibration</a></li>
<li><a class="reference internal" href="#store-calibration">2.11. Store Calibration</a></li>
<li><a class="reference internal" href="#monitor-dispense">2.12. Monitor Dispense</a></li>
<li><a class="reference internal" href="#get-dispense-data">2.13. Get Dispense Data</a></li>
<li><a class="reference internal" href="#stream">2.14. Stream</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="firmware_spec.html" title="previous chapter">1. Firmware Specification</a></li>
      <li>Next: <a href="interface_spec.html" title="next chapter">3. Interface Specification</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/interface_control_doc.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Creare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/interface_control_doc.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>